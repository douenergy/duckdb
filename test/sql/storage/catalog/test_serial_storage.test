# name: test/sql/storage/catalog/test_serial_storage.test
# description: Create and drop a serial over different runs
# group: [catalog]

require skip_reload


# load the DB from disk
load __TEST_DIR__/serial_storage.db

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
PRAGMA wal_autocheckpoint='1TB';


# create a table with serial type
statement ok
CREATE TABLE stooges (
    id serial,
    name text
);

statement ok
INSERT INTO stooges (name) VALUES ('Moe');

statement ok
INSERT INTO stooges (name) VALUES ('Bob');


# select the tabel
query II
FROM stooges ORDER BY id;
----
1	Moe
2	Bob

statement ok
DROP TABLE stooges;

######### first loop #########
loop i 0 2

# restart the system
restart

statement error
FROM tooges;

# after recreating the teble we read again
statement ok
CREATE TABLE stooges (
    id serial,
    name text
);

statement ok
INSERT INTO stooges (name) VALUES ('Moe');

statement ok
INSERT INTO stooges (name) VALUES ('Bob');


query II
FROM stooges ORDER BY id;
----
1	Moe
2	Bob

# drop the table again
statement ok
DROP TABLE stooges;

endloop
######### end first loop #########

# create a table with serial againg without deleting it this time
statement ok
CREATE TABLE stooges (
    id serial,
    name text
);

statement ok
INSERT INTO stooges (name) VALUES ('Moe');

statement ok
INSERT INTO stooges (name) VALUES ('Bob');

######### second loop #########
loop i 0 2

query II
FROM stooges ORDER BY id;
----
1	Moe
2	Bob

restart

endloop
######### end second loop #########

statement ok
DROP TABLE stooges;

#FIXME
statement ok
DROP SEQUENCE stooges_id_seq; 


# we can use foreach primary key (empty) 
# so we manually test create without primary key
# create a table with serial type without primary key
statement ok
CREATE TABLE stooges (
    id serial primary key,
    name text
);

statement ok
INSERT INTO stooges (name) VALUES ('Moe');

statement ok
INSERT INTO stooges (name) VALUES ('Bob');


# select the tabel
query II
FROM stooges ORDER BY id;
----
1	Moe
2	Bob

statement ok
DROP TABLE stooges;

loop i 0 2

# restart the system
restart

statement error
FROM tooges;

# after recreating the teble we read again
statement ok
CREATE TABLE stooges (
    id serial primary key,
    name text
);

statement ok
INSERT INTO stooges (name) VALUES ('Moe');

statement ok
INSERT INTO stooges (name) VALUES ('Bob');


query II
FROM stooges ORDER BY id;
----
1	Moe
2	Bob

# drop the table again
statement ok
DROP TABLE stooges;

endloop

# create a table with serial againg without deleting it this time
statement ok
CREATE TABLE stooges (
    id serial primary key,
    name text
);

statement ok
INSERT INTO stooges (name) VALUES ('Moe');

statement ok
INSERT INTO stooges (name) VALUES ('Bob');

loop i 0 2

query II
FROM stooges ORDER BY id;
----
1	Moe
2	Bob

restart

endloop
